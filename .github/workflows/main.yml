name: Deploy to VPS
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Prepare SSH for git
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh
          # Trust GitHubâ€™s host key (change hostname if your origin is GitLab/Bitbucket)
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          # Start agent and add the deploy key
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519

      - name: Update repo in place
        shell: bash
        run: |
          set -euxo pipefail
          git config --global --add safe.directory /srv/moon-studio
          cd /srv/moon-studio
          # Optional: show remote to confirm it's SSH
          git remote -v
          # Safer than pull: fast-forward to origin/main
          git fetch origin main
          git checkout -B main origin/main
          git reset --hard origin/main

      - name: Rebuild & restart
        shell: bash
        run: |
          set -euxo pipefail
          cd /srv/moon-studio
          docker compose pull
          docker compose build --no-cache app
          docker compose up -d
